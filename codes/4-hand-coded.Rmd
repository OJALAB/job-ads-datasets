---
title: "R Notebook"
output: html_notebook
---

```{r}
library(readxl)
library(writexl)
library(data.table)
library(stringr)
library(cld3)
```

regex patterns
```{r}
emails <- "([_a-z0-9-]+(\\.[_a-z0-9-]+)*@[a-z0-9-]+(\\.[a-z0-9-]+)*(\\.[a-z]{2,4}))"
phones1 <- "(\\d[.-])?\\(?\\d{3}\\)?[-. ]?\\d{3}[-. ]?\\d{3}\\b"
phones2 <- "(\\d[.-])?\\(?\\d{3}\\)?[-. ]?\\d{2}[-. ]?\\d{2}[-. ]?\\d{2}\\b"

## nazwiska
nazwiska <- fread("../data-helpers/pesel-nazwiska-meskie.csv", col.names = c("nazwisko"), select = 1)
nazwiska_kob <- fread("../data-helpers/pesel-nazwiska-zenskie.csv", col.names = c("nazwisko"), select = 1)
nazwiska_all <- tolower(unique(c(nazwiska$nazwisko, nazwiska_kob$nazwisko)))
length(nazwiska_all)
```

```{r}
hand1 <- read_excel("../data-raw/kom1-new.xlsx", col_types = "text")
hand1 <- setDT(hand1)
hand1[, job.description:=gsub("([a-ząćęłńóśźż])([A-ZĆĘŁŃÓŚŹŻ])","\\1 \\2", job.description)]
write_xlsx(hand1, path = "../data-raw/kom1-new-sep.xlsx")
```

after hand cleaning

```{r}
## read and replace emails
hand1 <- read_excel("../data-raw/kom1-new-sep-done.xlsx") |> setDT()
hand1[, job.description := str_replace_all(job.description, emails, " <<EMAIL>> ")]
hand1[, job.description:=str_replace_all(job.description, phones1, " <<PHONE>>")]
hand1[, job.description:=str_replace_all(job.description, phones2, " <<PHONE>>")]

# for (i in 1:length(nazwiska_all)) {
#   if (i %% 1000 == 0) {
#     cat("i: ", i, "\n")
#   }
#   hand1[, nazwisko := str_replace_all(job.description, regex(nazwiska_all[i], ignore_case = T), " <<NAZW>> ")]
# }
# 
# hand1[str_detect(nazwisko, "<<NAZW>>")]
```

```{r}
hand2 <- read_excel("../data-raw/kom2-new.xlsx", col_types = "text")
hand2 <- setDT(hand2)
hand2[, job.description:=gsub("([a-ząćęłńóśźż])([A-ZĆĘŁŃÓŚŹŻ])","\\1 \\2", job.description)]
write_xlsx(hand2, path = "../data-raw/kom2-new-sep.xlsx")

## read and replace emails

```

after hand cleaning

```{r}
hand2 <- read_excel("../data-raw/kom2-new-sep-done.xlsx") |> setDT()
hand2[, job.description := str_replace_all(job.description, emails, " <<EMAIL>> ")]
hand2[, job.description:=str_replace_all(job.description, phones1, " <<PHONE>>")]
hand2[, job.description:=str_replace_all(job.description, phones2, " <<PHONE>>")]

```

```{r}
hand3 <- read_excel("../data-raw/kom3-new.xlsx", col_types = "text")
hand3 <- setDT(hand3)
hand3[, job.description:=gsub("([a-ząćęłńóśźż])([A-ZĆĘŁŃÓŚŹŻ])","\\1 \\2", job.description)]
hand3[, job.description:=gsub("([1-9])([a-ząćęłńóśźżA-ZĆĘŁŃÓŚŹŻ])","\\1 \\2", job.description)]
write_xlsx(hand3, path = "../data-raw/kom3-new-sep.xlsx")

## read and replace emails

```

after hand cleaning

```{r}
hand3 <- read_excel("../data-raw/kom3-new-sep-done.xlsx") |> setDT()
hand3[, job.description := str_replace_all(job.description, emails, " <<EMAIL>> ")]
hand3[, job.description:=str_replace_all(job.description, phones1, " <<PHONE>>")]
hand3[, job.description:=str_replace_all(job.description, phones2, " <<PHONE>>")]

hand3[language.description == "en"]
```

Merging and cleaning

```{r}

```

